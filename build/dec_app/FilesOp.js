var electron=require("electron"),app=electron.app,Dict=require("Dict.js"),fs=require("fs-extra"),ipc=electron.ipcMain,FilesOp=function(){this.clearUndo()};FilesOp.prototype.hasUndo=function(e){return!(!this.hasUndo_||!e)&&(0==(this.undoTo_||"").indexOf(e)||0==(this.undoFrom_||"").indexOf(e))},FilesOp.prototype.undoLabel=function(){return this.undoLabel_},FilesOp.prototype.clearUndo=function(){this.undoFrom_="",this.undoTo_="",this.undoLabel_="",this.hasUndo_=!1},FilesOp.prototype.registerUndo=function(e,o,n){this.undoFrom_=e,this.undoTo_=o,this.undoLabel_=n,this.hasUndo_=!0};var showErrorMessage=function(e){electron.dialog.showErrorBox(Dict.getPanelString("Operation Failed"),e.message)};FilesOp.prototype.getFocusPath=function(){return this.hasUndo_&&this.undoTo_},FilesOp.prototype.performUndo=function(){if(this.hasUndo_){this.hasUndo_=!1;var e=this;this.undoTo_?fs.existsSync(this.undoTo_)?o():fs.copyFile(this.undoFrom_,this.undoTo_,function(n){fs.unlink(e.undoFrom_,function(){}),n?o():(app.sendEvent("didRename",{oldPath:this.undoFrom_,newPath:this.undoTo_}),e.clearUndo())}):fs.remove(this.undoFrom_,function(o){o?showErrorMessage(o):(e.clearUndo(),app.sendEvent("updateQuickOpenCache",{toDel:this.undoFrom_}))})}function o(){electron.dialog.showMessageBox({type:"warning",message:Dict.getPanelString("Operation Failed"),defaultId:0,cancelId:1,buttons:[Dict.getPanelString("Save As"),Dict.getPanelString("Cancel")]}).then(({response:o})=>{0==o?electron.dialog.showSaveDialog({defaultPath:e.undoTo_,properties:["showOverwriteConfirmation"]}).then(({filePath:o})=>{o&&o!=e.undoFrom_&&fs.rename(e.undoFrom_,o,function(e){e&&showErrorMessage(e)}),e.clearUndo()}):e.clearUndo()})}};var filesOp=new FilesOp;ipc.handle("filesOp.registerUndo",(e,o,n,t)=>{filesOp.registerUndo(o,n,t)}),ipc.handle("filesOp.clearUndo",e=>{filesOp.clearUndo()}),ipc.handle("filesOp.performUndo",e=>{filesOp.performUndo()}),ipc.handle("filesOp.getFocusPath",e=>filesOp.getFocusPath()),ipc.handle("filesOp.undoLabel",(e,o)=>filesOp.hasUndo(o)?filesOp.undoLabel():null),exports.default=filesOp;