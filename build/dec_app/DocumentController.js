var electron=require("electron"),app=electron.app,BrowserWindow=electron.BrowserWindow,powerMonitor=electron.powerMonitor,fs=require("fs-extra"),fsp=require("fs-plus"),util=require("util"),isWin="win32"==process.platform,isMac="darwin"==process.platform,isLinux="linux"==process.platform,Raven=require("raven"),windowController=require("WindowController.js"),ipc=require("electron").ipcMain;ipc.on("doc.syncChange",function(e,t){var n=BrowserWindow.fromWebContents(e.sender),o=app.documentController.getDocumentFromWindowId(n.id);n==o.activeWindow&&o.windows.size>1&&(t=JSON.parse(t),o.syncChange(t||[]),e.sender.send("scheduleFullContentSync"))});var Document=function(e,t){this.activeWindow=t||null,this.windows=new Set(t),this.path=e||null,this.snap=null,this.lastSync,this.content,this.backupState=null};Document.prototype.setContent=function(e){this.content=e},Document.prototype.getContent=function(){return this.content},Document.prototype.switchToUntitled=function(e){this.path&&(this.rename(null),this.windows.forEach(function(t){e&&t!=this.activeWindow?t.close():t.webContents.executeJavaScript("window.clientHandlerOnPresentationMoved()")},this))},Document.prototype.rename=function(e){wrapPathAsKey(this.path)!=wrapPathAsKey(e||"")&&(this.path&&(sharedInstance.path2doc.delete(wrapPathAsKey(this.path)),sharedInstance.name2docs.get(wrapPathAsKey(getFileNameFromPath_(this.path))).delete(this),app.setting.removeRecentDocument(this.path)),e&&sharedInstance.forceCloseFromPath(e),this.path=e,e&&(sharedInstance.path2doc.set(wrapPathAsKey(e),this),sharedInstance.solveDuplicateName_(this),app.setting.addRecentDocument(e)))},Document.prototype.shouldSaveSnap=function(){return this.path||this.windows.size>1||this.snap},Document.prototype.syncChange=function(e){var t;this.windows.size<=1||e&&e.length&&this.windows.forEach(function(n){try{n!==this.activeWindow&&(n.isDestroyed()||n.webContents.isDestroyed()||(t||(t=JSON.stringify(e)),n.webContents.executeJavaScript("File.editor.applyChange("+t+")")))}catch(t){Raven.captureException(t,{extra:{changes:e.map?e.map(function(e){return e.type}):"unknown"}})}},this)},Document.prototype.addSnap=function(e){!this.path&&this.windows.size<=1||!e?this.snap=null:(e.fromSourceMode?e.srcContent=e.content:this.snap&&(e.srcHist=this.snap.srcHist,e.srcContent=this.snap.srcContent),this.snap=e)},Document.prototype.enterOversize=function(){this.windows.forEach(function(e){this.activeWindow!=e&&e.webContents.executeJavaScript("File.tryEnterOversize('', true, true)")})},Document.prototype.getSnap=function(e){return this.snap&&this.snap.timeStamp>0&&this.snap.timeStamp==e?null:(this.snap&&(this.snap.lastSync=this.lastSync),this.snap)},Document.prototype.setLastSync=function(e){this.lastSync=e},Document.prototype.setActiveWindow=function(e){var t=this,n=e==this.activeWindow,o=app.focusedWindow==e;return!this.activeWindow||n||this.activeWindow.isDestroyed()?n?(e.webContents.executeJavaScript("window.onWindowFocusForNode && window.onWindowFocusForNode(true, "+o+")"),t.activeWindow=e,Promise.resolve()):(t.activeWindow=e,e.webContents.executeJavaScript("window.onWindowFocusForNode && window.onWindowFocusForNode("+n+", "+o+")")):t.activeWindow.webContents.executeJavaScript("window.onWindowResignForNode && window.onWindowResignForNode()").then(function(i){return t.activeWindow=e,e.webContents.executeJavaScript("window.onWindowFocusForNode && window.onWindowFocusForNode("+n+", "+o+")")})},Document.prototype.saveFromUntitled=function(e){this.windows.forEach(function(t){t.webContents.send("saveFromUntitled",e)})},Document.prototype.shouldReadFromDisk=async function(){return!await this.isSnapValid()},Document.prototype.isSnapValid=async function(){if(!this.path&&this.snap)return!0;if(this.snap&&this.lastSync>-1){if(this.snap.changeCounter&&!this.snap.changeCounter.curState)return!0;try{var e=(await fs.stat(this.path)).mtimeMs;return this.lastSync,this.snap.timeStamp,!this.lastSync||this.lastSync>=e}catch(e){console.warn(e)}return!1}},Document.prototype.getWindowToFocus=function(){var e=this.activeWindow||this.windows.keys().next().value;if(e){if(!e.isDestroyed())return e;this.activeWindow=null,this.windows.delete(e)}return null},Document.prototype.syncFullContent=function(e){var t=!1;if(this.windows.forEach(function(n){this.activeWindow!=n&&!t&&(n.inSourceMode&&!e||!n.inSourceMode&&e)&&(t=!0)}),t){var n=this.windows;return this.activeWindow.webContents.executeJavaScript("File.sync(false, true);1;").then(function(){n.forEach(function(t){this.activeWindow!=t&&(t.inSourceMode&&!e||!t.inSourceMode&&e)&&t.webContents.executeJavaScript("File.editor.applyFullContent("+!!e+")")})}),null}},Document.prototype.popBackupState=async function(){var e=this.backupState;return this.backupState=void 0,e instanceof Promise?await e:e};var getFileNameFromPath_=function(e){return require("path").basename(e)},isFsCaseInsensitive=fsp.isCaseInsensitive();function wrapPathAsKey(e){return isFsCaseInsensitive&&e?e.toLowerCase():e}var DocumentController=function(){this.documents=new Set,this.path2doc=new Map,this.win2doc=new Map,this.name2docs=new Map,this.frozenDocs=[],this.watchSystemPause()};function execJsForDocument(e,t){e.windows.forEach(function(e){try{e.isDestroyed()||e.webContents.isDestroyed()||webContent.executeJavaScript(t)}catch(e){Raven.captureException(e,{level:"warning",extra:{js:t}}),console.error("Execute js {"+t+"} on every window failed "+e.message)}})}DocumentController.prototype.watchSystemPause=function(){app.whenReady().then(()=>{powerMonitor.on("suspend",()=>{console.log("The system is going to sleep"),this.documents.forEach(e=>{e.activeWindow&&e.activeWindow.webContents.executeJavaScript("window.File && File.saveAndBackup()")})})})},DocumentController.prototype.setContentForWindow=function(e,t){var n=this.getDocumentFromWindowId(t);(n.activeWindow||{}).id==t&&n.setContent(e)},DocumentController.prototype.solveDuplicateName_=function(e){var t=e.path,n=wrapPathAsKey(getFileNameFromPath_(t)),o=this.name2docs.get(n)||new Set;this.name2docs.set(n,o),o.length>0&&o.forEach(function(e){execJsForDocument(e,"File.FileInfoPanel.setFileTitle(File.filePath);")}),o.add(e)},DocumentController.prototype.openFile=function(e,t){t=t||{};var n=this,o=this.getDocument(e),i=t.prepWindow,r=t.displayNow,s=t.forceCreateWindow;if(o){var a=o.getWindowToFocus();if(r&&a&&a.focus(),!s&&(!i||a))return Promise.resolve(o)}else e=e&&require("path").normalize(e),o=this.recallDoc(e)||new Document(e),e&&(this.path2doc.set(wrapPathAsKey(e),o),this.documents.add(o),this.solveDuplicateName_(o),app.setting.addRecentDocument(e)),t.backupState&&(o.backupState=t.backupState);return(i?(a=windowController.makeWindow(r,{initMountFolder:t.mountFolder,mountFolder:t.mountFolder,pinFolder:t.pinFolder,silentOpenFailure:t.silent,showSidebar:t.showSidebar}),n.addWindowToDocument_(o,a).then(function(){isLinux&&process.argv.length<=1&&readStdin(a),r&&a.focus()})):Promise.resolve()).then(function(){return o})},DocumentController.prototype.addWindowToDocument_=function(e,t){return this.win2doc.set(t.id,e),e.windows.add(t),app.addBackup({id:t.id,path:e.path}),e.setActiveWindow(t)},DocumentController.prototype.getDocument=function(e){return e?(e=wrapPathAsKey(require("path").normalize(e)),this.path2doc.get(e)):null},DocumentController.prototype.getDocumentFromWindowId=function(e){var t=this.win2doc.get(e);return t&&t.activeWindow&&t.activeWindow.isDestroyed()&&t.setActiveWindow(BrowserWindow.fromId(e)),t},DocumentController.prototype.removeWindow=function(e){var t=this.getDocumentFromWindowId(e),n=this,o=BrowserWindow.fromId(e);function i(){t.activeWindow==o&&(t.activeWindow=null),app.focusedWindow==o&&(app.focusedWindow=null),t.windows.delete(o),0==t.windows.size&&(app.removeBackup(e),n.removeDocument(t)),n.win2doc.delete(e)}if(t){if(t.activeWindow==o)return o.webContents.executeJavaScript("window.File && File.backupDocumentSnap && File.backupDocumentSnap()").then(i);i()}return Promise.resolve()},DocumentController.prototype.frozenDoc=function(e){e.snap&&e.snap.nodeMap&&e.path&&(this.frozenDocs.length>10&&this.frozenDocs.splice(5,this.frozenDocs.length-5),this.frozenDocs.push(e))},DocumentController.prototype.recallDoc=function(e){if(e){for(var t,n=this.frozenDocs.length,o=0,i=-1;o<n;o++){var r=this.frozenDocs[o];if(r.path&&(isFsCaseInsensitive?r.path.toLowerCase()==e.toLowerCase():r.path==e)){i=o,t=r;break}}return this.frozenDocs.splice(i,1),t}},DocumentController.prototype.removeDocument=function(e){this.documents.delete(e),e.path&&(this.path2doc.delete(wrapPathAsKey(e.path)),this.name2docs.get(wrapPathAsKey(getFileNameFromPath_(e.path))).delete(e),e.activeWindow=null,e.windows=new Set,this.frozenDoc(e))},DocumentController.prototype.forceCloseFromPath=function(e){if(e){var t=this.getDocument(e);t&&Array.from(t.windows).forEach(function(e){this.removeWindow(e.id).then(function(){e.destroy()})},this)}},DocumentController.prototype.hasDuplicateName=function(e){return!!e&&(this.name2docs.get(wrapPathAsKey(e))||[]).length>1},DocumentController.prototype.switchDocument=function(e,t){var n=BrowserWindow.fromId(e),o=this.getDocumentFromWindowId(e),i=this.getDocument(t),r=this;return o==i?Promise.resolve(i):(console.log("switchDocument "+e+" ["+t+"]"),(i?Promise.resolve(i):this.openFile(t)).then(function(t){return i=t,r.removeWindow(e)}).then(function(){return r.addWindowToDocument_(i,n)}).then(function(){return i}))};var readStdin=function(e){var t=[];process.stdin.setEncoding("utf8"),process.stdin.on("data",function(e){console.log("==read==\n"+e),t.push(e)}),process.stdin.on("end",function(){if(t.length)try{var n="File.reloadContent("+JSON.stringify(t.join("\n"))+")";e.webContents.executeJavaScript(n)}catch(e){console.error(e.message)}})};ipc.handle("document.switchToUntitled",(e,t,n)=>{var o=BrowserWindow.fromWebContents(e.sender),i=t?app.getDocumentController().getDocument(t):app.documentController.getDocumentFromWindowId(o.id);i&&i.activeWindow==o&&i&&i.switchToUntitled(n)}),ipc.handle("document.setLastSync",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender);app.documentController.getDocumentFromWindowId(n.id).setLastSync(t)}),ipc.handle("document.syncFullContent",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender);app.documentController.getDocumentFromWindowId(n.id).syncFullContent(t)}),ipc.handle("document.getContent",e=>{var t=BrowserWindow.fromWebContents(e.sender);app.documentController.getDocumentFromWindowId(t.id).getContent()}),ipc.handle("document.currentPath",e=>{var t=BrowserWindow.fromWebContents(e.sender);return app.documentController.getDocumentFromWindowId(t.id).path}),ipc.handle("document.loadInitData",async e=>{console.log("handle document.loadInitData");var t=BrowserWindow.fromWebContents(e.sender),n=app.documentController.getDocumentFromWindowId(t.id),o=n.getSnap(null),i=n.path,r=!1,s=null;return(o||{}).nodeMap?r=await n.shouldReadFromDisk():s=await n.popBackupState(),s&&s.hasUnsaved?console.log(`load from recover content length: ${s.content.length}`):s=null,JSON.stringify({snap:o,filePath:i,backups:s,shouldReadFromDisk:r})}),ipc.handle("document.switchDocument",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender);return app.getDocumentController().switchDocument(n.id,t).then(async e=>{var t=await e.shouldReadFromDisk();return JSON.stringify({snap:e.getSnap(null),shouldReadFromDisk:t,windowCounts:e.windows.size})})}),ipc.handle("document.rename",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender);return app.documentController.getDocumentFromWindowId(n.id).rename(t),!0}),ipc.handle("document.setContent",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender);return app.documentController.getDocumentFromWindowId(n.id).setContent(t),!0}),ipc.handle("document.addSnap",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender),o=app.documentController.getDocumentFromWindowId(n.id);return t?o.addSnap(JSON.parse(t)):o.addSnap(null),!0}),ipc.handle("document.addSnapAndLastSync",(e,t)=>{try{var n=BrowserWindow.fromWebContents(e.sender),o=app.documentController.getDocumentFromWindowId(n.id);if(t){var{snap:i,lastSync:r}=JSON.parse(t);o.addSnap(i),o.setLastSync(r)}else o.addSnap(null)}catch(e){console.error(e)}return!0}),ipc.handle("document.shouldSaveSnap",e=>{var t=BrowserWindow.fromWebContents(e.sender);return app.documentController.getDocumentFromWindowId(t.id).shouldSaveSnap()}),ipc.handle("document.getSnap",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender),o=app.documentController.getDocumentFromWindowId(n.id);return JSON.stringify(o.getSnap(t))}),ipc.handle("document.getSnapWithValidation",async(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender),o=app.documentController.getDocumentFromWindowId(n.id),i=await o.isSnapValid();return JSON.stringify({snap:o.getSnap(t),shouldReadFromDisk:!i})}),ipc.handle("document.enterOversize",e=>{var t=BrowserWindow.fromWebContents(e.sender),n=app.documentController.getDocumentFromWindowId(t.id);n&&n.enterOversize()}),ipc.handle("document.newWindow",e=>{3==app.setting.get("restoreWhenLaunch")?app.openFile(null,{mountFolder:app.setting.get("pinFolder"),silent:"pinFolder"}):app.openFile()}),ipc.handle("document.checkIfMoveOnSave",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender),o=app.documentController.getDocument(t);return!o&&((o=app.documentController.getDocumentFromWindowId(n.id)).rename(t),!0)}),ipc.handle("document.hasDuplicateName",(e,t)=>app.documentController.hasDuplicateName(t)),ipc.handle("document.noOtherWindow",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender);return app.documentController.getDocumentFromWindowId(n.id).windows.size<=1});var sharedInstance=new DocumentController;exports=module.exports=sharedInstance;