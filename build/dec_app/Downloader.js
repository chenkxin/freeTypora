var fs=require("fs-extra"),path=require("path"),defaultDisplayOption={title:"Download",text:"Downloadingâ€¦",indeterminate:!1,initialValue:0,maxValue:1,closeOnComplete:!1,abortOnError:!1,style:{text:{padding:"3px 0"}},browserWindow:{modal:!1,closable:!0,webPreferences:{nodeIntegration:!0,contextIsolation:!1}}};function humanReadableByteCount(o){if(o<1024)return o+" B";var e=o/Math.pow(1024,1),t=o/Math.pow(1024,2);return t<1?(e+"").replace(/(\..)(.+)$/,"$1")+"KB":(t+"").replace(/(\..)(.+)$/,"$1")+"MB"}function DownloadTask(o,e,t){this.onAbort=null,this.onSuccess=null,this.onError=null,this.downloadURL=o,this.dist=e,this.displayOption=t||{},this.progressBar=null,this.downloadItem=null}DownloadTask.prototype.cancel=function(){if(this.downloadItem){try{this.downloadItem.cancel()}catch(o){}this.downloadItem=null}this.setCompleted(),this.onAbort&&this.onAbort()},DownloadTask.prototype.setCompleted=function(){this.downloadItem=null,this.progressBar&&(this.progressBar.setCompleted(),this.progressBar.close(),this.progressBar=null)},DownloadTask.prototype.download=function(){var o=require("electron-progressbar"),e=require("electron-dl"),t=this,n=this.downloadURL,a=this.dist,l=this.displayOption,r=new o(Object.assign({},defaultDisplayOption,l));this.progressBar=r,r.on("aborted",function(){t.cancel()});var s=path.dirname(a);Promise.all([new Promise(function(o){r.on("ready",o)}),fs.ensureDir(s)]).then(function(){console.record(`[downloader] downloading ${n}`,"DEBUG"),e.download(r._window,n,{showBadge:l.showBadge||!1,directory:s,filename:path.basename(a),onProgress:function(o){r&&(r.value=o.percent*(l.processOnComplete||1),r.detail=humanReadableByteCount(o.transferredBytes)+" / "+humanReadableByteCount(o.totalBytes))},onStarted:function(o){console.log("start downloading "+o.getURL()),t.downloadItem=o},onCancel:function(){console.log("canceled downloading "+downloadItem.getURL()),t.cancel()}}).then(function(o){t.onSuccess(o,r)}).catch(function(o){console.log("error downloading "+(t.downloadItem&&t.downloadItem.getURL())),t.onError(o)})})},module.exports=DownloadTask;