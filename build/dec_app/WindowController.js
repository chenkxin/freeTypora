var lastWinState,electron=require("electron"),app=electron.app,ipc=electron.ipcMain,BrowserWindow=electron.BrowserWindow,License=require("License.js"),Raven=require("raven"),isWin="win32"==process.platform,isLinux="linux"==process.platform,t_workingDir=require("path").join(__dirname,"../");function validatePosition(e,n){var o,t=electron.screen;if(null!=e.x){null==(o=t.getDisplayNearestPoint({x:e.x||0,y:e.y||0}))&&(o=t.getPrimaryDisplay());var i=o.workArea;e.y<i.y?e.y=n?i.y+i.height-e.height:i.y:e.y+e.height>i.y+i.height&&(e.y=i.y+i.height-e.height),e.x<i.x?e.x=i.x:e.x+e.width>i.x+i.width&&(e.x=n?i.x:i.x+i.width-e.width)}}ipc.handle("window.setTitle",(e,n,o)=>{var t=BrowserWindow.fromWebContents(e.sender);n||(n="Typora"===(n=t.getTitle())?"Untitled"+(o?"• - Typora":" - Typora"):n.replace(/•? - Typora$/,o?"• - Typora":" - Typora")),t.setTitle(n)}),ipc.handle("window.focus",e=>{var n=BrowserWindow.fromWebContents(e.sender);return n.focus(),n.webContents.focus(),!0}),ipc.handle("window.setInSourceMode",(e,n)=>{BrowserWindow.fromWebContents(e.sender).inSourceMode=!!n}),ipc.handle("window.minimize",e=>{BrowserWindow.fromWebContents(e.sender).minimize()}),ipc.handle("window.close",e=>{BrowserWindow.fromWebContents(e.sender).close()}),ipc.handle("window.restore",e=>{var n=BrowserWindow.fromWebContents(e.sender);n.unmaximize(),n.setFullScreen(!1)}),ipc.handle("window.maximize",e=>{BrowserWindow.fromWebContents(e.sender).maximize()}),ipc.handle("window.fullscreen",e=>{var n=BrowserWindow.fromWebContents(e.sender);return n.setFullScreen(!0),n.isFullScreen()}),ipc.handle("window.setMenuBarVisibility",(e,n)=>{BrowserWindow.fromWebContents(e.sender).setMenuBarVisibility(n)}),ipc.handle("window.pin",e=>{BrowserWindow.fromWebContents(e.sender).setAlwaysOnTop(!0)}),ipc.handle("window.unpin",e=>{BrowserWindow.fromWebContents(e.sender).setAlwaysOnTop(!1)}),ipc.handle("window.updateMenuForIsAlwaysOnTop",e=>{var n={"View→Always on Top":{state:BrowserWindow.fromWebContents(e.sender).isAlwaysOnTop()}};app.updateMenu(n)}),ipc.handle("window.toggleDevTools",e=>{var n=BrowserWindow.fromWebContents(e.sender);n.webContents.isDevToolsOpened()?n.webContents.closeDevTools():n.webContents.openDevTools()}),ipc.handle("window.inspectElement",(e,n,o)=>{BrowserWindow.fromWebContents(e.sender).inspectElement(n,o)}),ipc.handle("window.checkAsFocus",e=>{var n=BrowserWindow.fromWebContents(e.sender);n&&n.isFocused&&(app.currentFocusWindowId=n.id)}),ipc.handle("controller.switchFolder",(e,n)=>{var o=BrowserWindow.fromWebContents(e.sender);app.switchFolder(n,o)}),ipc.handle("webContents.copy",e=>{BrowserWindow.fromWebContents(e.sender).webContents.copy()}),ipc.handle("webContents.cut",e=>{BrowserWindow.fromWebContents(e.sender).webContents.cut()}),ipc.handle("webContents.paste",e=>{BrowserWindow.fromWebContents(e.sender).webContents.paste()}),ipc.handle("webContents.selectAll",e=>{BrowserWindow.fromWebContents(e.sender).webContents.selectAll()}),ipc.handle("webContents.undo",(e,n)=>{BrowserWindow.fromWebContents(e.sender).webContents.undo()}),ipc.handle("webContents.redo",(e,n)=>{BrowserWindow.fromWebContents(e.sender).webContents.redo()}),ipc.handle("webContents.action",(e,n)=>{BrowserWindow.fromWebContents(e.sender).webContents[n]()}),exports.makeWindow=((e,n)=>{var o=app.getDocumentController();n=n||{};var t=BrowserWindow.getFocusedWindow(),i=app.setting.config||{},s=o.lastClosedBounds,r=t&&t.getBounds(),a=0;s||(r?(a=t.isMaximized()||t.isFullScreen()?0:30,s={fullscreen:t.isFullScreen(),maximized:t.isMaximized()},a&&(s.x=r.x+a,s.y=r.y+a,s.width=r.width,s.height=r.height)):lastWinState?(a=lastWinState.fullscreen||lastWinState.maximize?0:30,s={x:lastWinState.x+a,y:lastWinState.y-a,width:lastWinState.width,height:lastWinState.height,fullscreen:lastWinState.fullscreen,maximized:lastWinState.maximized}):s={});var d=!s.fullscreen&&s.maximized,l={x:s.x,y:s.y,width:s.width||800,height:s.height||700,minWidth:400,minHeight:400,frame:!app.setting.get("framelessWindow"),disableAutoHideCursor:!1,backgroundColor:app.setting.get("backgroundColor"),webPreferences:{plugins:!1,nodeIntegration:!0,enableRemoteModule:!1,webviewTag:!0,nodeIntegrationInWorker:!0,devTools:!0,images:i.images,directWrite:i.directWrite,defaultFontFamily:i.defaultFontFamily,allowDisplayingInsecureContent:!0,backgroundThrottling:!1,spellcheck:!1,contextIsolation:!1,additionalArguments:["--tyopt="+JSON.stringify({isMaximized:d,isFullScreen:s.fullscreen,...app.setting.buildOption(),...n})]},autoHideMenuBar:s.fullscreen||i.autoHideMenuBar,show:e,fullscreen:s.fullscreen,alwaysOnTop:t&&t.isAlwaysOnTop(),fullscreenable:!0};isLinux&&(l.icon=t_workingDir+"/assets/icon/icon_256x256.png"),validatePosition(l,a>0),lastWinState=l,d&&(l.show=!1);var c=new BrowserWindow(l);return o.lastClosedBounds=null,d&&(c.maximize(),e&&c.show()),s.fullscreen&&(c.autoHideMenuBar=!0,c.setMenuBarVisibility(!1)),c.loadURL("file://"+t_workingDir+"/window.html"),function(e){var n=electron.shell;e.webContents.on("will-navigate",function(e,o){e.preventDefault(),n.openExternal(o)}),e.webContents.setWindowOpenHandler(e=>(/^https?:/.exec(e.url)&&n.openExternal(e.url),{action:"deny"})),e.webContents.on("crashed",function(e,n){console.error("render process is killed? "+n),Raven.captureMessage("render process crashed, killed="+n),app.setting.addAnalyticsEvent("crashed")}),e.webContents.on("unresponsive",function(){Raven.captureMessage("unresponsive",{extra:{winId:e.id}}),app.setting.addAnalyticsEvent("unresponsive")}),e.webContents.on("dom-ready",function(){e.isMaximized()&&e.webContents.executeJavaScript('document.body.classList.add("typora-maxmized");'),License.appendLicenseHintIfNeeded(e)}),e.on("maximize",()=>{e.webContents.executeJavaScript('document.body.classList.add("typora-maxmized");')}),e.on("enter-full-screen",function(){e.webContents.executeJavaScript('document.body.classList.add("typora-maxmized");document.body.classList.add("typora-fullscreen");if(document.body.classList.contains("native-window")) {$("#ty-top-placeholder").show();};1;')}),e.on("unmaximize",function(){e.webContents.executeJavaScript('document.body.classList.remove("typora-maxmized");')}),e.on("session-end",function(){console.log("[win] session-end"),e.webContents.executeJavaScript("if(File.backupWindow){File.backupWindow(true);File.saveAndBackup()};1;")}),e.on("leave-full-screen",function(){e.autoHideMenuBar=!!app.setting.config.autoHideMenuBar,e.setMenuBarVisibility(!app.setting.config.autoHideMenuBar),e.webContents.executeJavaScript('document.body.classList.remove("typora-maxmized");document.body.classList.remove("typora-fullscreen");$("#ty-top-placeholder").hide();1;'),lastWinState&&(lastWinState.fullscreen=!1)}),e.on("focus",function(){e.webContents.incrementCapturerCount();var n=o.getDocumentFromWindowId(e.id);n&&(n.setActiveWindow(e),app.focusedWindow=e)}),e.on("blur",()=>{console.log("[win] blur"),e.webContents.executeJavaScript("if(File.backupWindow){File.backupWindow(true);File.saveAndBackup()};1;")})}(c),License.showLicensePanelIfNeeded(),c}),exports.showPanelWindow=function({path:e,...n}){var o=new BrowserWindow({modal:!0,show:!1,center:!0,resizable:!1,webPreferences:{devTools:!global.releaseMode,defaultFontSize:14,nodeIntegration:!0,contextIsolation:!1,enableRemoteModule:!1},...n});const t="file://"+t_workingDir+"/"+e;return o.loadURL(t),o.once("ready-to-show",function(){o.show()}),o.removeMenu(),isLinux&&(o.icon=t_workingDir+"/assets/icon/icon_256x256.png"),o.webContents.setWindowOpenHandler(e=>(electron.shell.openExternal(e.url),{action:"deny"})),o};