var electron=require("electron"),app=electron.app,ipc=electron.ipcMain,BrowserWindow=electron.BrowserWindow,isWin="win32"==process.platform,isLinux="linux"==process.platform,Dict=require("Dict.js"),menuHelper=require("menu.js");exports.bindJumplist=(()=>{if(isWin){var e=[{type:"custom",name:"Recent Locations",items:app.setting.getRecentFolders().slice(0,5).map(function(e){return{type:"task",title:e.name,description:e.path,program:process.execPath,args:JSON.stringify(e.path),iconPath:"explorer.exe",iconIndex:0}})},{type:"recent"},{type:"tasks",items:[{type:"task",program:process.execPath,arguments:"--new",iconPath:process.execPath,iconIndex:0,title:"New"}]}];app.setAppUserModelId("abnerworks.Typora"),app.setJumpList(e),menuHelper.loadDict().then(t=>{e[0].name=t["Recent Locations"]||"Recent Locations",e[2].items[0].title=t.New||"New",app.setAppUserModelId("abnerworks.Typora"),app.setJumpList(e)})}}),ipc.handle("shell.openItem",(e,t)=>electron.shell.openPath(t)),ipc.handle("shell.trashItem",async(e,t)=>{try{return await electron.shell.trashItem(t),!0}catch(e){return!1}}),ipc.handle("shell.openExternal",(e,t)=>{if("about:blank"!=t)return electron.shell.openExternal(t)}),ipc.handle("shell.showItemInFolder",(e,t)=>(isWin&&(t=t.replace(/\//g,"\\")),electron.shell.showItemInFolder(t))),ipc.handle("dialog.showMessageBox",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender);return electron.dialog.showMessageBox(isLinux?null:n,t)}),ipc.handle("dialog.showSaveDialog",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender);return electron.dialog.showSaveDialog(isLinux?null:n,t)}),ipc.handle("dialog.showOpenDialog",(e,t)=>{var n=BrowserWindow.fromWebContents(e.sender);return electron.dialog.showOpenDialog(isLinux?null:n,t)}),ipc.handle("dialog.showOpenDialogAlone",(e,t)=>electron.dialog.showOpenDialog(t));const sleep=e=>new Promise(t=>{setTimeout(()=>{t("sleep")},e)}),genPrintView=async(e,t)=>{var n,r=new BrowserWindow({skipTaskbar:!0,title:"Print PDF Preview",show:!1,webPreferences:{webSecurity:!1,allowDisplayingInsecureContent:!0,allowRunningInsecureContent:!1,nodeIntegration:!1,safeDialogs:!1,directWrite:app.setting.config.directWrite,defaultFontFamily:app.setting.config.defaultFontFamily,zoomFactor:(app.setting.get("zoomFactor")||"1")-0,backgroundThrottling:!1}});try{if(t)console.log("load file ["+t+"] for PDF export"),n=r.loadURL("file:///"+t);else{var i=require("path").join(app.getPath("temp"),new Date-0+"tmp.html"),o=require("fs-extra");console.log("write output to temp file ["+i+"] for PDF export"),await o.outputFile(i,e),n=r.loadURL("file:///"+i)}}catch(e){return console.error(e),r&&r.destroy(),null}return Promise.race([sleep(1e4),n]).then(e=>"sleep"===e?(destroyPrintView(r.id),console.warn("Timeout for loading print view"),null):r.id).catch(e=>(console.error(e),r&&r.destroy(),null))};ipc.handle("export.genPrintView",(e,t,n)=>(n&&destroyPrintView(n),genPrintView(null,t)));const destroyPrintView=e=>{var t=BrowserWindow.fromId(e);t&&(t.isDestroyed()||t.destroy())};ipc.handle("export.destroyPrintView",(e,t)=>{destroyPrintView(t)}),ipc.handle("export.getPageColor",async(e,t)=>{try{let e=await genPrintView(null,t);if(console.log("generate print preview window with id "+e),!e)return null;printWin=BrowserWindow.fromId(e),await sleep(200);var n=await printWin.webContents.executeJavaScript("window.getComputedStyle(document.body).backgroundColor")}catch(e){console.error(e)}finally{printWin&&printWin.destroy()}return n}),ipc.handle("export.print",(e,t,n)=>{var r=BrowserWindow.fromId(t);n=n||{},r.webContents.print(n,(e,i)=>{if(!e&&!/cancel/.exec(i||"")){if("no valid printers available"===i)return void r.webContents.executeJavaScript("window.print()").then(()=>{n.skipCleanUp||destroyPrintView(t)});electron.dialog.showMessageBox({type:"error",message:Dict.getPanelString("Error"),detail:i,buttons:["OK"]})}n.skipCleanUp||destroyPrintView(t)})}),ipc.handle("export.printToPDF",async(e,t,n)=>{let r=null,i=null,o="",a="";try{let e=await genPrintView(null,t);if(console.log("generate print window with id "+e),!e)return[i,o];r=BrowserWindow.fromId(e),await sleep(200),i=await r.webContents.printToPDF(n),console.log("get PDF data"),o=await r.webContents.executeJavaScript("window.getComputedStyle(document.querySelector('#write')).color"),console.log("get background color")}catch(e){a=e.message||"",console.error(e)}finally{r&&r.destroy()}return[i,o,a]});var imageWidth,pandocVersion,PAGE_HEIGHT=isWin?8e3:960,scale=1;function updateTheme(){console.log("updateTheme");var e=app.setting.curTheme();app.execInAll("window.ClientCommand && File.setTheme('"+e+"');");var t=e.replace(/\.css$/,"").replace(/(^|-|_)(\w)/g,function(e,t,n,r){return(t?" ":"")+n.toUpperCase()}),n=electron.Menu.getApplicationMenu().getItem("Themes");n&&n.submenu.items.map(function(e){e.checked=e.label==t})}ipc.handle("export.prepareImageCapture",async(e,t,n)=>{var r;try{if(scale=electron.screen.getPrimaryDisplay().scaleFactor||1,imageWidth=n.imageWidth,r=new BrowserWindow({skipTaskbar:!0,show:!1,webPreferences:{devTools:!1,webSecurity:!1,allowDisplayingInsecureContent:!0,allowRunningInsecureContent:!0,nodeIntegration:!1,directWrite:app.setting.config.directWrite,defaultFontFamily:app.setting.config.defaultFontFamily,zoomFactor:app.setting.get("zoomFactor"),safeDialogs:!0},webgl:!1,useContentSize:!0,width:n.imageWidth,height:PAGE_HEIGHT,frame:!1,enableLargerThanScreen:!!isWin,offscreen:!0,alwaysOnTop:!0,minimizable:!1,closable:!0}),await r.loadURL("file:///"+t),r.isDestroyed())return null;if(await sleep(2e3),r.isDestroyed())return null;var i=await r.webContents.executeJavaScript("window.innerHeight")-0;if(r.isDestroyed())return null;var o=await r.webContents.executeJavaScript("document.body.parentElement.scrollTop = document.body.clientHeight;\nMath.max(document.body.clientHeight, document.body.parentElement.scrollHeight)")-0;if(r.isDestroyed())return null;if(Number.isNaN(o)||Number.isNaN(i))return;return isLinux&&(PAGE_HEIGHT=i),{winId:r.id,totalHeight:o,pageHeight:PAGE_HEIGHT,imageWidth:n.imageWidth}}catch(e){return console.error(e),null==r||r.isDestroyed()||r.destroy(),null}}),ipc.handle("export.captureImage",async(e,t,n,r)=>{var i=BrowserWindow.fromId(t);if(!i||i.isDestroyed())return null;try{r&&(i.setSize(r.imageWidth,r.pageHeight),i.setContentSize(r.imageWidth,r.pageHeight));var o=await i.webContents.executeJavaScript("document.body.parentElement.scrollTop = {d}; document.body.parentElement.scrollHeight;".replace("{d}",n))-0;if(await sleep(1e3),i.isDestroyed()||Number.isNaN(o))return null;var a=await i.webContents.capturePage();return!a||a.isEmpty()?null:(scale>1&&(a=a.resize({width:r.imageWidth||imageWidth,quality:"best"})),JSON.stringify({newScrollHeight:o,data:a.toDataURL()}))}catch(e){return console.error(e),i.destroy(),null}}),ipc.handle("url.request",(e,t)=>new Promise((e,n)=>{try{var r=electron.net.request({url:t,redirect:"follow"});r.on("response",function(t){try{if(200!=t.statusCode)return e(null);if(!t.data)return e(null);e({type:(t.headers["content-type"]||[""])[0],data:t.data})}catch(t){e(null)}}),r.end()}catch(t){e(null)}})),ipc.handle("clipboard.write",(e,t,n)=>{n&&electron.clipboard.clear(),electron.clipboard.write(JSON.parse(t))}),ipc.handle("pandoc.import",(e,t)=>{var n,r,i={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"'":"\\'","\\":"\\\\"},o=BrowserWindow.fromWebContents(e.sender);return n=t?Promise.resolve(o):app.openFile(null,{syncAndPrepOnly:!0}).then(e=>new Promise(t=>{let n=e.activeWindow.webContents;n.isLoading()?n.once("did-finish-load",function(){t(e.activeWindow)}):t(e.activeWindow)})),r=electron.dialog.showOpenDialog(t?o:null,{title:menuHelper.getMenuDict.Import,properties:["openFile"],filters:[{name:Dict.getPanelString("All Supported Formats"),extensions:["docx","latex","tex","ltx","rst","rest","org","wiki","dokuwiki","mediawiki","textile","opml","epub"]},{name:"MS Word",extensions:["docx"]},{name:"TeX/LaTeX",extensions:["latex","tex","ltx"]},{name:"reStructuredText",extensions:["rst","rest"]},{name:"org-mode",extensions:["org"]},{name:"Wiki",extensions:["wiki","dokuwiki","mediawiki"]},{name:"Epub",extensions:["epub"]},{name:"Textile",extensions:["textile"]},{name:"OPML",extensions:["opml"]}]}).then(({filePaths:e})=>(e||[null])[0]),Promise.all([n,r]).then(async([e,n])=>{n?(await sleep(100),e.show(),e.webContents.executeJavaScript('window.getSelection().removeAllRanges();ClientCommand.doImport("'+function(e){return e.replace(/["'\\\b\t\n\f\r]/g,function(e){return i[e]}).replace(/\u200b/g,"")}(n)+'")')):t||e.destroy()})}),ipc.handle("pandoc.version",()=>pandocVersion),ipc.handle("pandoc.setVersion",(e,t)=>{pandocVersion=t}),electron.nativeTheme.on("updated",function(){null!==app.setting.useDarkThemeBefore()&&app.setting.useDarkThemeBefore()!==app.setting.useDarkTheme()&&updateTheme()}),ipc.handle("theme.apply",()=>{updateTheme()}),ipc.handle("theme.setThemeSource",(e,t)=>{"system"===(t=t||"system")?electron.nativeTheme.themeSource=t:app.setting.get("useSeparateDarkTheme")||(electron.nativeTheme.themeSource=t)}),ipc.on("ondragstart",function(e,t,n){setTimeout(function(){var r=electron.nativeImage;e.sender.startDrag({file:t,icon:n?r.createFromPath(require("path").normalize(n)):r.createEmpty()}),console.log("ondragstart "+t+" "+n)},100)}),ipc.handle("getPath",(e,t)=>app.getPath(t));